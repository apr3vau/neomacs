<h1 class="">Reactive DOM</h1><p class="">Neomacs maintain reactive DOMs based on <code>lwcells</code>. This enables observers and computed attributes to update in real-time depending on DOM content.</p><h2 class="">Nodes</h2><p class="">This section documents the low-level node classes making up Neomacs's reactive DOM. Note that the interface here is low-level in the sense that <code>text-node</code>'s are being exposed. The majority of Neomacs API hides <code>text-node</code>'s as an implementation detail and the DOM conceptually consists of <code>element</code>'s and <code>character</code>'s.</p><ul><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">classdoc</span><span class="symbol">'node</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">classdoc</span><span class="symbol">'text-node</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">classdoc</span><span class="symbol">'element</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'element-p</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'text-node-p</span></div></span></li><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'tag-name-p</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'clone-node</span></div></span></li><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'child-nodes</span></div></span></li><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'children</span></div></span></li><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'text-content</span></div></span></li><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'get-elements-by-class-name</span></div></span></li></ul><h2 class="">Traversing DOM</h2><ul><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'do-dom</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'do-elements</span></div></span></li></ul><h2>Attributes</h2><p>In Neomacs, every attribute is backed by a cell, i.e. other cells can depend on attribute value, or attribute values themselves can be computed and updated from other cell value. The following functions get and set attribute values or function to compute them.</p><ul><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'attribute</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'set-attribute-function</span></div></span></li></ul><p>Attributes can have any name. Those named by strings are kept in sync with renderer-side attributes with the same names, i.e. changes in Lisp side are pushed to renderer (but not the other way). Those with non-string names (typically symbols) instead has no counterpart on renderer side.</p><p>Attribute related utility functions:</p><ul><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'add-class</span></div></span></li><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'remove-class</span></div></span></li><li><span class="comma-expr"><div class="list"><span class="symbol" operator="">fundoc</span><span class="symbol">'class-p</span></div></span></li></ul><h2><p>Low-level DOM edits</p></h2><p>This section documents low-level primitives for modifying Lisp-side DOM. They are used to implement programmer-facing editing operations, see <a href="edit.html#editing-primitives">Editing primitives</a>.</p><ul><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'insert-before</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'append-child</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'append-children</span></div></span></li><li><span class="comma-expr" operator=""><div class="list" operator=""><span class="symbol" operator="">fundoc</span><span class="symbol">'remove-node</span></div></span></li></ul><h2>Notes on DOM consistency</h2><p>It is imperative that Lisp-side and renderer-side DOM are consistent. Otherwise, editing operations may behave erroneously and inconsistency can be propagated and amplified. All belts are off  in such case (which can be recovered only by re-opening the buffer, or in some case <code>revert-buffer</code>).</p><p>Currently, the following consistency rules are enforced:</p><ul><li>Lisp-side and renderer-side DOM must have exactly the same structure, i.e. <code>element</code>'s and <code>text-node</code>'s must 1-1 correspond. Parent, child and sibling (order included) relations must be exactly the same.</li><li>Length of  corresponding text nodes must be exactly the same.</li><li>It is acceptable that corresponding elements have different tag-names.</li><p>For example, <code>render-focus</code> currently exploit this to change <code>br</code> element into <code>div</code> element when focused, to display visible highlight.</p><li>It is acceptable that corresponding text nodes have different characters at the same offset.</li><li>It is acceptable that corresponding elements have different attribute values for an attribute named by a string on Lisp-side, but keep in mind that changes from Lisp-side will be pushed to renderer and overwrite its values.</li><li>It is totally ok that renderer-side element has some attribute not known to Lisp-side. This is useful for internal bookkeeping done by JavaScript code which Lisp doesn't need to know. Lisp-side has similar ability by using attributes not named by strings.</li></ul>